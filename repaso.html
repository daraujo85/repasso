<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulado Interactivo ‚Äì Repaso I (JSON)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { font-family: Arial, sans-serif; background:#f8fafc; color:#222; margin:0; padding:0; font-size:18px; line-height:1.6; }
    header { 
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); 
      color:#fff; 
      padding:30px 20px; 
      text-align:center; 
      position: sticky; 
      top: 0; 
      z-index: 1000; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    header h1 { 
      margin:0 0 8px 0; 
      font-size:32px; 
      font-weight:700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
    }
    header h1 i { font-size:28px; }
    header p { 
      margin:0; 
      font-size:16px; 
      opacity:0.95;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    header p i { font-size:14px; }
    main { max-width:1000px; margin:20px auto; padding:10px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:10px; padding:50px; margin:25px 0; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
    h2 { font-size:22px; margin:0 0 15px; color:#333; }
    label { display:block; margin:12px 0 6px; font-weight:bold; }
    .row { display:flex; gap:12px; align-items:flex-start; margin-top:10px; }
    .num { width:32px; font-weight:bold; }
    input.inp { width:100%; padding:12px; font-size:18px; border:1px solid #bbb; border-radius:6px; }
    .feedback { margin-top:6px; }
    .ok { color:#065f46; background:#d1fae5; padding:8px; border-radius:6px; }
    .bad { color:#991b1b; background:#fee2e2; padding:8px; border-radius:6px; }
    .actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; justify-content:flex-end; }
    button { font-size:18px; padding:12px 20px; border:none; border-radius:6px; cursor:pointer; }
    #btnCheck { background:#4f46e5; color:#fff; }
    #btnClear { background:#e5e7eb; }
    #scoreBox { text-align:right; font-weight:bold; margin-bottom:15px; font-size:20px; }
    .progress-bar { background:#e5e7eb; border-radius:6px; overflow:hidden; height:25px; margin:8px; }
    .progress-fill { background:linear-gradient(to right,#4f46e5,#3b82f6); height:100%; width:0%; transition:width .2s ease; }
    .badge { display:inline-block; background:#fff7ed; color:#c2410c; border:1px solid #fdba74; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:10px; }
    .prompt-media { margin:0 0 12px; }
    .prompt-media img { max-width:100%; height:auto; display:block; border-radius:6px; }
    .prompt-audio { margin:0 0 12px; width:100%; }
    .prompt-audio audio { 
      width:100%; 
      max-width:100%; 
      height:50px;
      border-radius:12px;
      background:linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      outline:none;
    }
    .prompt-audio audio::-webkit-media-controls-panel {
      background:linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
      border-radius:12px;
    }
    .prompt-audio audio::-webkit-media-controls-play-button {
      background-color:#4f46e5;
      border-radius:50%;
      margin-right:10px;
    }
    .prompt-audio audio::-webkit-media-controls-current-time-display,
    .prompt-audio audio::-webkit-media-controls-time-remaining-display {
      color:#1e293b;
      font-weight:500;
      font-size:13px;
    }
    .prompt-audio audio::-webkit-media-controls-timeline {
      background:#cbd5e1;
      border-radius:2px;
      height:4px;
    }
    .prompt-audio audio::-webkit-media-controls-timeline::-webkit-slider-thumb {
      background:#4f46e5;
      border-radius:50%;
      width:12px;
      height:12px;
    }
    .prompt-audio audio::-webkit-media-controls-volume-slider {
      background:#cbd5e1;
      border-radius:2px;
      height:4px;
    }
    .prompt-audio audio::-webkit-media-controls-volume-slider::-webkit-slider-thumb {
      background:#4f46e5;
      border-radius:50%;
      width:10px;
      height:10px;
    }
    .prompt-audio audio::-webkit-media-controls-mute-button {
      background-color:transparent;
    }
    /* Dark mode para audio */
    body.dark-mode .prompt-audio audio {
      background:linear-gradient(135deg, #1f2937 0%, #374151 100%);
    }
    body.dark-mode .prompt-audio audio::-webkit-media-controls-panel {
      background:linear-gradient(135deg, #1f2937 0%, #374151 100%);
    }
    body.dark-mode .prompt-audio audio::-webkit-media-controls-play-button {
      background-color:#6366f1;
    }
    body.dark-mode .prompt-audio audio::-webkit-media-controls-current-time-display,
    body.dark-mode .prompt-audio audio::-webkit-media-controls-time-remaining-display {
      color:#e5e7eb;
    }
    body.dark-mode .prompt-audio audio::-webkit-media-controls-timeline {
      background:#4b5563;
    }
    body.dark-mode .prompt-audio audio::-webkit-media-controls-timeline::-webkit-slider-thumb {
      background:#6366f1;
    }
    body.dark-mode .prompt-audio audio::-webkit-media-controls-volume-slider {
      background:#4b5563;
    }
    body.dark-mode .prompt-audio audio::-webkit-media-controls-volume-slider::-webkit-slider-thumb {
      background:#6366f1;
    }
    /* sticky container para manter nota e progresso vis√≠veis */
    .sticky-top { position: sticky; top: 72px; z-index: 999; padding: 8px 0; background: #f8fafc; box-shadow: 0 2px 5px rgba(0,0,0,0.06); }
    .sticky-top #scoreBox { margin: 10px; }
    
    /* seletor de simulados, discreto e √† direita */
    .sim-selector { display:flex; justify-content:flex-end; align-items:center; gap:8px; margin: 6px 10px 0; }
    .sim-select { font-size:14px; padding:6px 8px; border:1px solid #ddd; border-radius:6px; background:#fff; }
    
    /* bot√£o WhatsApp */
    .wa-btn { background:#25D366; color:#fff; }
    /* bot√£o Reportar Erro */
    .report-btn { background:#dc2626; color:#fff; }
    /* bot√£o Imprimir */
    #btnPrint { background:#6366f1; color:#fff; }
    /* Footer */
    footer { background:#1e293b; color:#e2e8f0; padding:30px 20px; margin-top:40px; text-align:center; font-size:14px; }
    footer a { color:#60a5fa; text-decoration:none; }
    footer a:hover { text-decoration:underline; }
    footer .credits { margin:10px 0; }
    footer .credits i { margin:0 5px; }
    /* Bot√£o Dark Mode */
    #btnDarkMode { position:fixed; top:20px; right:20px; z-index:1001; background:#374151; color:#fff; border:none; border-radius:50%; width:50px; height:50px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.2); transition:all 0.3s ease; display:flex; align-items:center; justify-content:center; }
    #btnDarkMode:hover { background:#4b5563; transform:scale(1.1); }
    #btnDarkMode i { font-size:20px; line-height:1; }
    /* Dark Mode Styles */
    body.dark-mode { background:#111827; color:#e5e7eb; }
    body.dark-mode header { 
      background: linear-gradient(135deg, #1f2937 0%, #374151 100%); 
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    body.dark-mode .card { background:#1f2937; border-color:#374151; color:#e5e7eb; }
    body.dark-mode .card h2 { color:#f3f4f6; }
    body.dark-mode .sticky-top { background:#111827; }
    body.dark-mode input.inp, body.dark-mode select.sel, body.dark-mode select { background:#374151; border-color:#4b5563; color:#e5e7eb; }
    body.dark-mode input.inp:focus, body.dark-mode select:focus { border-color:#6366f1; outline:none; }
    body.dark-mode .badge { background:#4b5563; color:#fbbf24; border-color:#6b7280; }
    body.dark-mode .ok { background:#064e3b; color:#6ee7b7; }
    body.dark-mode .bad { background:#7f1d1d; color:#fca5a5; }
    body.dark-mode .progress-bar { background:#374151; }
    body.dark-mode .sim-select { background:#374151; border-color:#4b5563; color:#e5e7eb; }
    body.dark-mode #btnClear { background:#374151; color:#e5e7eb; }
    body.dark-mode #btnClear:hover { background:#4b5563; }
    body.dark-mode .report-btn { background:#991b1b; }
    body.dark-mode .report-btn:hover { background:#b91c1c; }
    body.dark-mode footer { background:#0f172a; }
    body.dark-mode #btnTopo { background:linear-gradient(135deg,#374151,#4b5563); }
    body.dark-mode #btnTopo:hover { background:linear-gradient(135deg,#4b5563,#6b7280); }
    body.dark-mode #btnFinal { background:linear-gradient(135deg,#4b5563,#6b7280); }
    body.dark-mode #btnFinal:hover { background:linear-gradient(135deg,#6b7280,#9ca3af); }
    /* Estilos para impress√£o */
    @media print {
      header, .sticky-top, .actions, #btnTopo, #btnFinal, footer { display:none !important; }
      .card { page-break-inside:avoid; margin:10px 0; }
      body { background:#fff; }
      .feedback { display:none !important; }
      input, select { border:1px solid #000 !important; }
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-graduation-cap"></i> Simulado Interactivo ‚Äì Repaso I</h1>
    <p><i class="fas fa-check-double"></i> Responda e veja o feedback imediato.</p>
  </header>

  <button id="btnDarkMode" onclick="toggleDarkMode()" title="Alternar modo escuro/claro" aria-label="Alternar modo escuro">
    <i class="fas fa-moon"></i>
  </button>

  <main>
    <div class="sticky-top">
      <div id="scoreBox"><i class="fas fa-star"></i> Nota: 0%</div>
      <div class="progress-bar"><div id="progress" class="progress-fill"></div></div>
      <div class="sim-selector">
        <span style="font-weight:normal; font-size:14px; color:#555;"><i class="fas fa-list"></i> Simulado:</span>
        <select id="simSelect" class="sim-select">
          <option value="">Carregando simulados...</option>
        </select>
      </div>
    </div>
    <!-- container das se√ß√µes geradas dinamicamente -->
    <div id="quiz"></div>

    <div class="actions">      
      <button id="btnClear" onclick="location.reload()"><i class="fas fa-redo"></i> Novo Simulado</button>
      <button id="btnShare" class="wa-btn" onclick="shareWhatsApp()"><i class="fab fa-whatsapp"></i> Compartilhar no WhatsApp</button>
      <button id="btnReport" class="report-btn" onclick="reportError()"><i class="fas fa-bug"></i> Reportar Erro</button>
      <button id="btnPrint" onclick="window.print()"><i class="fas fa-print"></i> Imprimir / Salvar PDF</button>
    </div>
  </main>

  <footer>
    <div class="credits">
      <p><strong>Desenvolvido por Diego Araujo</strong></p>
      <p>
        <a href="mailto:diegoaraujo@devysnc.com.br"><i class="fas fa-envelope"></i> diegoaraujo@devysnc.com.br</a> | 
        <a href="https://devysnc.com.br" target="_blank" rel="noopener noreferrer"><i class="fas fa-globe"></i> devysnc.com.br</a> | 
        <a href="https://wa.me/5521995278672" target="_blank" rel="noopener noreferrer"><i class="fab fa-whatsapp"></i> WhatsApp</a> | 
        <a href="https://instagram.com/diegoaraujo85" target="_blank" rel="noopener noreferrer"><i class="fab fa-instagram"></i> Instagram</a>
      </p>
    </div>
  </footer>

  <script>
    let totalQuestions = 0;

    // util: embaralhar array
    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // util: ordenar por numero ascendente
    function sortByNumero(items) {
      return (items || []).slice().sort((a, b) => {
        const na = Number(a?.numero);
        const nb = Number(b?.numero);
        const va = Number.isFinite(na) ? na : Number.MAX_SAFE_INTEGER;
        const vb = Number.isFinite(nb) ? nb : Number.MAX_SAFE_INTEGER;
        return va - vb;
      });
    }

    // Escolhe aleatoriamente uma variante por n√∫mero, mantendo ordem num√©rica
    function chooseVariants(items) {
      const byNum = {};
      (items || []).forEach(it => {
        const n = Number(it?.numero);
        const key = Number.isFinite(n) ? n : (it?.numero ?? '');
        if (!byNum[key]) byNum[key] = [];
        byNum[key].push(it);
      });
      const chosen = Object.keys(byNum).map(k => {
        const arr = byNum[k];
        return arr[Math.floor(Math.random() * arr.length)];
      });
      return sortByNumero(chosen);
    }

    // util: obter slug do query param (suporta ?slug=, ?s=, ?simulado=)
    function getSlugParam() {
      const params = new URLSearchParams(location.search);
      return (params.get('slug') || params.get('s') || params.get('simulado') || '').toLowerCase();
    }

    // util: obter par√¢metro de grupo (suporta ?group=, ?grupo=, ?section=)
    function getGroupParam() {
      const params = new URLSearchParams(location.search);
      return (params.get('group') || params.get('grupo') || params.get('section') || '');
    }

    function getGroupSetParam() {
      const params = new URLSearchParams(location.search);
      const raw = params.get('groupset') || params.get('gs') || params.get('set');
      if (!raw) return null;
      const idx = Number(raw);
      if (!Number.isInteger(idx) || idx < 0) return null;
      return idx;
    }

    // Compartilhar via WhatsApp o simulado atual
    function shareWhatsApp() {
      try {
        const sel = document.getElementById('simSelect');
        const currentSlug = sel ? (sel.value || '') : '';
        const url = new URL(location.href);
        if (currentSlug) {
          url.searchParams.set('slug', currentSlug);
        }
        // Remover par√¢metros de grupo para link mais limpo
        url.searchParams.delete('group');
        url.searchParams.delete('grupo');
        url.searchParams.delete('section');
        url.searchParams.delete('groupset');
        url.searchParams.delete('gs');
        url.searchParams.delete('set');
        const title = (document.querySelector('header h1')?.textContent || 'Simulado').trim();
        const msg = `Vamos praticar? ${title}\n${url.toString()}`;
        const shareUrl = 'https://wa.me/?text=' + encodeURIComponent(msg);
        window.open(shareUrl, '_blank');
      } catch (e) {
        console.error('Falha ao compartilhar no WhatsApp', e);
        alert('N√£o foi poss√≠vel abrir o compartilhamento.');
      }
    }

    // Reportar erro ou bug via WhatsApp
    function reportError() {
      try {
        const sel = document.getElementById('simSelect');
        const currentSlug = sel ? (sel.value || 'N/A') : 'N/A';
        const currentUrl = window.location.href;
        const timestamp = new Date().toLocaleString('pt-BR');
        const title = (document.querySelector('header h1')?.textContent || 'Simulado').trim();
        
        // Construir mensagem usando s√≠mbolos ASCII simples para melhor compatibilidade
        const messageText = 
          '*REPORTE DE ERRO - Simulado de Espanhol*\n\n' +
          '*Simulado:* ' + title + ' (' + currentSlug + ')\n' +
          '*URL:* ' + currentUrl + '\n' +
          '*Data/Hora:* ' + timestamp + '\n\n' +
          '*Tipo de problema:*\n' +
          '[ ] Erro na formula√ß√£o da pergunta\n' +
          '[ ] Bug no sistema\n' +
          '[ ] Problema com m√≠dia (√°udio/imagem/v√≠deo)\n' +
          '[ ] Outro problema\n\n' +
          '*Descri√ß√£o do problema:*\n' +
          '(Descreva o problema encontrado aqui)\n\n' +
          '*Sugest√£o de corre√ß√£o (opcional):*\n' +
          '(Se tiver uma sugest√£o, descreva aqui)';
        
        // Usar encodeURIComponent para codificar corretamente
        const encodedMessage = encodeURIComponent(messageText);
        
        window.open('https://wa.me/5521995278672?text=' + encodedMessage, '_blank');
      } catch (e) {
        console.error('Falha ao abrir WhatsApp para reportar erro', e);
        alert('Erro ao abrir WhatsApp. Por favor, entre em contato manualmente: 5521995278672');
      }
    }

    // UI: renderiza seletor de simulados sem poluir a tela
    let selectorChangeHandler = null;
    function renderSimuladosSelector(simulados, selectedSlug) {
      const sel = document.getElementById('simSelect');
      if (!sel) return;
      
      // Remove event listener anterior se existir
      if (selectorChangeHandler) {
        sel.removeEventListener('change', selectorChangeHandler);
        selectorChangeHandler = null;
      }
      
      sel.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Selecione um simulado...';
      placeholder.disabled = true;
      placeholder.selected = !selectedSlug;
      sel.appendChild(placeholder);

      // Adiciona todas as op√ß√µes de simulados
      console.log('Populando seletor com', simulados?.length || 0, 'simulados');
      (simulados || []).forEach((s, idx) => {
        const opt = document.createElement('option');
        opt.value = (s.slug || '').toLowerCase();
        opt.textContent = s.title || s.slug || 'Simulado';
        console.log(`  Adicionando op√ß√£o ${idx + 1}: ${opt.textContent} (${opt.value})`);
        if (selectedSlug && opt.value === String(selectedSlug).toLowerCase()) {
          opt.selected = true;
          placeholder.selected = false;
        }
        sel.appendChild(opt);
      });
      console.log('Total de op√ß√µes no seletor:', sel.options.length);

      // Adiciona event listener
      selectorChangeHandler = () => {
        const val = sel.value;
        if (val) {
          const url = new URL(location.href);
          url.searchParams.set('slug', val);
          // remover grupo se existir para evitar confus√£o
          url.searchParams.delete('group');
          url.searchParams.delete('grupo');
          url.searchParams.delete('section');
          url.searchParams.delete('groupset');
          url.searchParams.delete('gs');
          url.searchParams.delete('set');
          location.href = url.toString();
        }
      };
      sel.addEventListener('change', selectorChangeHandler);
    }

    async function loadSimulado() {
      try {
        // Adiciona timestamp para evitar cache
        const res = await fetch('questoes.json?v=' + Date.now());
        const data = await res.json();
        const slug = getSlugParam();
        let simulado = null;

        // Debug: verificar simulados carregados
        console.log('Simulados carregados:', data.simulados?.length || 0);
        if (data.simulados) {
          data.simulados.forEach(s => {
            console.log(`  - ${s.title} (slug: ${s.slug})`);
          });
        }

        // popula seletor com todos os simulados, j√° destacando o atual (se houver)
        renderSimuladosSelector((data.simulados || []), slug);
    
        if (slug) {
          simulado = (data.simulados || []).find(s => (s.slug || '').toLowerCase() === slug);
        }
    
        // Se um slug foi informado mas n√£o existe, mostra mensagem amig√°vel e n√£o faz fallback
        if (slug && !simulado) {
          const quiz = document.getElementById('quiz');
          const headerTitle = document.querySelector('header h1');
          if (headerTitle) {
            headerTitle.textContent = 'Simulado ‚Äì n√£o dispon√≠vel';
          }
          quiz.innerHTML = `
            <section class="card">
              <h2>Simulado indispon√≠vel</h2>
              <p>üòî Desculpe, o simulado solicitado ainda n√£o est√° dispon√≠vel.</p>
              <p>Verifique o endere√ßo ou escolha outro simulado.</p>
            </section>
          `;
          return;
        }
    
        // Sem slug, escolhe um simulado aleat√≥rio como comportamento padr√£o
        if (!slug) {
          const sims = data.simulados || [];
          simulado = sims[Math.floor(Math.random() * sims.length)];
          // atualiza seletor para refletir o escolhido aleatoriamente
          renderSimuladosSelector((data.simulados || []), simulado?.slug || '');
        }
    
        // normaliza e ordena o conjunto de perguntas para o render (ordem num√©rica)
        if (Array.isArray(simulado?.questions)) {
          simulado = { ...simulado, questions: sortByNumero(simulado.questions) };
        } else if (Array.isArray(simulado?.groupsSets)) {
          // novo formato: groupsSets (array de conjuntos de grupos)
          const normalizedSets = (simulado.groupsSets || []).map(set =>
            (set || []).map(g => ({
              ...g,
              items: chooseVariants((g.items || g.perguntas || g.questions || []))
            }))
          );
          if (normalizedSets.length > 0) {
            const paramIndex = getGroupSetParam();
            let chosenIndex = Math.floor(Math.random() * normalizedSets.length);
            if (paramIndex !== null && paramIndex >= 0 && paramIndex < normalizedSets.length) {
              chosenIndex = paramIndex;
            }
            const chosen = normalizedSets[chosenIndex];
            simulado = { ...simulado, groupsSets: normalizedSets, groups: chosen, __fromGroupsSets: true, __groupSetIndex: chosenIndex };
          }
        } else if (Array.isArray(simulado?.groups)) {
          simulado = {
            ...simulado,
            groups: (simulado.groups || []).map(g => ({
              ...g,
              items: chooseVariants((g.items || g.perguntas || g.questions || []))
            }))
          };
          // Seleciona group por par√¢metro (index 1-based ou parte do t√≠tulo); se n√£o houver, escolhe aleatoriamente
          const groupParam = getGroupParam();
          if ((simulado.groups || []).length > 0 && !simulado.__fromGroupsSets) {
            let selected = null;
            if (groupParam) {
              const gp = groupParam.trim().toLowerCase();
              const asIndex = Number(gp);
              if (Number.isFinite(asIndex) && asIndex >= 1 && asIndex <= simulado.groups.length) {
                selected = simulado.groups[asIndex - 1];
              } else {
                selected = simulado.groups.find(g => (g.title || '').toLowerCase().includes(gp)) || null;
              }
            }
            if (!selected) {
              selected = simulado.groups[Math.floor(Math.random() * simulado.groups.length)];
            }
            simulado = { ...simulado, groups: [selected] };
          }
        }
    
        // atualiza t√≠tulo no header
        const headerTitle = document.querySelector('header h1');
        if (headerTitle) {
          headerTitle.textContent = `Simulado ‚Äì ${simulado.title || 'Repaso I'}`;
        }
        // garante que o seletor reflita o simulado carregado
        renderSimuladosSelector((data.simulados || []), simulado?.slug || slug || '');
    
        renderQuiz(simulado);
      } catch (e) {
        const quiz = document.getElementById('quiz');
        quiz.innerHTML = '<div class="bad">Erro ao carregar questoes.json</div>';
        console.error(e);
      }
    }

    function renderQuiz(simulado) {
      const quiz = document.getElementById('quiz');
      quiz.innerHTML = '';

      let count = 0;

      // novo formato preferido: questions (lista plana)
      if (Array.isArray(simulado.questions)) {
        const section = document.createElement('section');
        section.className = 'card';
        section.innerHTML = `<h2>${simulado.title || 'Simulado'}</h2>`;

        (simulado.questions || []).forEach((q, idx) => {
          const wrap = document.createElement('div');
          wrap.className = 'row';
          const number = q.numero ?? (idx + 1);
            wrap.dataset.gabarito = JSON.stringify(q.gabarito || []);
            wrap.dataset.msg = q.mensagem || '';
            if (q.validacao || q.validacion) {
              wrap.dataset.validacao = JSON.stringify(q.validacao || q.validacion);
            }
            const t = q.type || q.tipo || (Array.isArray(q.opcoes) ? 'mc' : 'text');
          wrap.dataset.type = t;
          const imgSrc = q.imagem || q.image || q.imageUrl;
          const altText = q.altImagem || q.alt || q.legenda || ("Imagem da questao " + number);
          const imgHtml = imgSrc ? '<figure class="prompt-media"><img src="' + imgSrc + '" alt="' + altText + '" loading="lazy"></figure>' : '';
          const audioSrc = q.audio || q.audioUrl || q.audioLink || q.som;
          const audioHtml = audioSrc ? '<figure class="prompt-audio"><audio controls preload="none" src="' + audioSrc + '"></audio></figure>' : '';

          let inputHtml = '';
          if (t === 'mc' && Array.isArray(q.opcoes)) {
            const name = `q-questions-${number}`;
            inputHtml = q.opcoes.map(opt => `<label style="display:block; margin:6px 0;"><input type="radio" name="${name}" value="${opt}"> ${opt}</label>`).join('');
          } else if (t === 'vf') {
            const name = `q-questions-${number}`;
            inputHtml = `<label style="display:block; margin:6px 0;"><input type="radio" name="${name}" value="V"> Verdadeiro</label>` +
                        `<label style="display:block; margin:6px 0;"><input type="radio" name="${name}" value="F"> Falso</label>`;
          } else if (t === 'select' && Array.isArray(q.opcoes)) {
            inputHtml = `<select class="sel" style="width:100%; padding:12px; font-size:18px; border:1px solid #bbb; border-radius:6px;">` +
                        q.opcoes.map(opt => `<option value="${opt}">${opt}</option>`).join('') +
                        `</select>`;
          } else if (t === 'assoc' && Array.isArray(q.pares)) {
            const options = q.pares.map(p => p.b);
            inputHtml = `<div class="assoc">` +
                        q.pares.map((p, i) => `<div style="display:flex; gap:8px; align-items:center; margin:6px 0;"><div style="width:32px; font-weight:bold;">${i+1})</div><div style="flex:1;">${p.a}</div><div style="min-width:200px;"><select class="assoc-sel" style="width:100%; padding:10px; font-size:16px; border:1px solid #bbb; border-radius:6px;"><option value="" selected disabled>Seleccione...</option>` +
                        options.map(opt => `<option value=\"${opt}\">${opt}</option>`).join('') +
                        `</select></div></div>`).join('') + `</div>`;
            // sobrescreve gabarito com ordem correta das correspond√™ncias
            wrap.dataset.gabarito = JSON.stringify(options);
          } else if (t === 'checkbox' && Array.isArray(q.opcoes)) {
            const name = `q-questions-${number}`;
            inputHtml = q.opcoes.map(opt => `<label style="display:block; margin:6px 0;"><input type="checkbox" name="${name}" value="${opt}"> ${opt}</label>`).join('');
          } else {
            inputHtml = `<input class="inp" type="text" spellcheck="true" lang="es">`;
          }
          wrap.innerHTML = `
            <div class="num">${number}.</div>
            <div style="flex:1">
              ${imgHtml}${audioHtml}
              <label class="label">${q.enunciado}</label>
              ${inputHtml}
              <div class="feedback"></div>
            </div>
          `;
          section.appendChild(wrap);
        });

        quiz.appendChild(section);
        count = (simulado.questions || []).length;
      } else if (Array.isArray(simulado.groups)) {
        // grupos (se√ß√µes)
        simulado.groups.forEach((group, gidx) => {
          const section = document.createElement('section');
          section.className = 'card';
          const title = group.title || `Se√ß√£o ${gidx + 1}`;
          const badge = group.badge || '';
          const groupImgSrc = group.imagem || group.image || group.imageUrl || '';
          const groupImgAlt = group.altImagem || group.alt || group.legenda || (title + ' - Imagem');
          const groupImgHtml = groupImgSrc ? `<figure class="prompt-media" style="margin-bottom: 20px;"><img src="${groupImgSrc}" alt="${groupImgAlt}" loading="lazy" style="max-width: 100%; height: auto; border-radius: 6px;"></figure>` : '';
          const groupAudioSrc = group.audio || group.audioUrl || group.audioLink || group.som || '';
          const groupAudioHtml = groupAudioSrc ? `<figure class="prompt-audio" style="margin-bottom: 20px; width: 100%;"><audio controls preload="none" src="${groupAudioSrc}" style="width: 100%; max-width: 100%;"></audio></figure>` : '';
          section.innerHTML = `<h2>${title}${badge ? ` <span class="badge">${badge}</span>` : ''}</h2>${groupImgHtml}${groupAudioHtml}`;

          const groupItems = group.items || group.perguntas || group.questions || [];
          groupItems.forEach((q, idx) => {
            count++;
            const wrap = document.createElement('div');
            wrap.className = 'row';
            const number = q.numero ?? idx + 1;
            wrap.dataset.gabarito = JSON.stringify(q.gabarito || []);
            wrap.dataset.msg = q.mensagem || '';
            if (q.validacao || q.validacion) {
              wrap.dataset.validacao = JSON.stringify(q.validacao || q.validacion);
            }
            const t = q.type || q.tipo || (Array.isArray(q.opcoes) ? 'mc' : 'text');
            wrap.dataset.type = t;
            const imgSrc = q.imagem || q.image || q.imageUrl;
            const altText = q.altImagem || q.alt || q.legenda || ("Imagem da questao " + number);
            const imgHtml = imgSrc ? '<figure class="prompt-media"><img src="' + imgSrc + '" alt="' + altText + '" loading="lazy"></figure>' : '';
            const audioSrc = q.audio || q.audioUrl || q.audioLink || q.som;
            const audioHtml = audioSrc ? '<figure class="prompt-audio"><audio controls preload="none" src="' + audioSrc + '"></audio></figure>' : '';

            let inputHtml = '';
            if (t === 'mc' && Array.isArray(q.opcoes)) {
              const name = `q-${gidx}-${number}`;
              inputHtml = q.opcoes.map(opt => `<label style="display:block; margin:6px 0;"><input type="radio" name="${name}" value="${opt}"> ${opt}</label>`).join('');
            } else if (t === 'vf') {
              const name = `q-${gidx}-${number}`;
              inputHtml = `<label style="display:block; margin:6px 0;"><input type="radio" name="${name}" value="V"> Verdadeiro</label>` +
                          `<label style="display:block; margin:6px 0;"><input type="radio" name="${name}" value="F"> Falso</label>`;
            } else if (t === 'select' && Array.isArray(q.opcoes)) {
              inputHtml = `<select class="sel" style="width:100%; padding:12px; font-size:18px; border:1px solid #bbb; border-radius:6px;">` +
                          q.opcoes.map(opt => `<option value="${opt}">${opt}</option>`).join('') +
                          `</select>`;
            } else if (t === 'assoc' && Array.isArray(q.pares)) {
              const options = q.pares.map(p => p.b);
              inputHtml = `<div class="assoc">` +
                          q.pares.map((p, i) => `<div style="display:flex; gap:8px; align-items:center; margin:6px 0;"><div style="width:32px; font-weight:bold;">${i+1})</div><div style="flex:1;">${p.a}</div><div style="min-width:200px;"><select class="assoc-sel" style="width:100%; padding:10px; font-size:16px; border:1px solid #bbb; border-radius:6px;"><option value="" selected disabled>Seleccione...</option>` +
                          options.map(opt => `<option value=\"${opt}\">${opt}</option>`).join('') +
                          `</select></div></div>`).join('') + `</div>`;
              // sobrescreve gabarito com ordem correta das correspond√™ncias
              wrap.dataset.gabarito = JSON.stringify(options);
            } else if (t === 'checkbox' && Array.isArray(q.opcoes)) {
              const name = `q-${gidx}-${number}`;
              inputHtml = q.opcoes.map(opt => `<label style="display:block; margin:6px 0;"><input type="checkbox" name="${name}" value="${opt}"> ${opt}</label>`).join('');
            } else {
              inputHtml = `<input class="inp" type="text" spellcheck="true" lang="es">`;
            }

            wrap.innerHTML = `
              <div class="num">${number}.</div>
              <div style="flex:1">
                ${imgHtml}${audioHtml}
                <label class="label">${q.enunciado}</label>
                ${inputHtml}
                <div class="feedback"></div>
              </div>
            `;
            section.appendChild(wrap);
          });

          quiz.appendChild(section);
        });
      } else {
        // legado plano: √∫nica se√ß√£o
        const items = Object.values(simulado);
        count = items.length;

        const section = document.createElement('section');
        section.className = 'card';
        section.innerHTML = `<h2>Simulado</h2>`;

        items.forEach((q, idx) => {
          const wrap = document.createElement('div');
          wrap.className = 'row';
          const number = q.numero ?? (idx + 1);
            wrap.dataset.gabarito = JSON.stringify(q.gabarito || []);
            wrap.dataset.msg = q.mensagem || '';
            if (q.validacao || q.validacion) {
              wrap.dataset.validacao = JSON.stringify(q.validacao || q.validacion);
            }
            const t = q.type || q.tipo || (Array.isArray(q.opcoes) ? 'mc' : 'text');
          wrap.dataset.type = t;
          const imgSrc = q.imagem || q.image || q.imageUrl;
          const altText = q.altImagem || q.alt || q.legenda || ("Imagem da questao " + number);
          const imgHtml = imgSrc ? '<figure class="prompt-media"><img src="' + imgSrc + '" alt="' + altText + '" loading="lazy"></figure>' : '';
          const audioSrc = q.audio || q.audioUrl || q.audioLink || q.som;
          const audioHtml = audioSrc ? '<figure class="prompt-audio"><audio controls preload="none" src="' + audioSrc + '"></audio></figure>' : '';

            let inputHtml = '';
            if (t === 'mc' && Array.isArray(q.opcoes)) {
              const name = `q-legacy-${number}`;
              inputHtml = q.opcoes.map(opt => `<label style="display:block; margin:6px 0;"><input type="radio" name="${name}" value="${opt}"> ${opt}</label>`).join('');
            } else if (t === 'vf') {
              const name = `q-legacy-${number}`;
              inputHtml = `<label style="display:block; margin:6px 0;"><input type="radio" name="${name}" value="V"> Verdadeiro</label>` +
                          `<label style="display:block; margin:6px 0;"><input type="radio" name="${name}" value="F"> Falso</label>`;
            } else if (t === 'select' && Array.isArray(q.opcoes)) {
              inputHtml = `<select class="sel" style="width:100%; padding:12px; font-size:18px; border:1px solid #bbb; border-radius:6px;">` +
                          q.opcoes.map(opt => `<option value="${opt}">${opt}</option>`).join('') +
                          `</select>`;
            } else if (t === 'assoc' && Array.isArray(q.pares)) {
              const options = q.pares.map(p => p.b);
              inputHtml = `<div class="assoc">` +
                          q.pares.map((p, i) => `<div style="display:flex; gap:8px; align-items:center; margin:6px 0;"><div style="width:32px; font-weight:bold;">${i+1})</div><div style="flex:1;">${p.a}</div><div style="min-width:200px;"><select class="assoc-sel" style="width:100%; padding:10px; font-size:16px; border:1px solid #bbb; border-radius:6px;"><option value="" selected disabled>Seleccione...</option>` +
                          options.map(opt => `<option value=\"${opt}\">${opt}</option>`).join('') +
                          `</select></div></div>`).join('') + `</div>`;
              // sobrescreve gabarito com ordem correta das correspond√™ncias
              wrap.dataset.gabarito = JSON.stringify(options);
            } else if (t === 'checkbox' && Array.isArray(q.opcoes)) {
              const name = `q-legacy-${number}`;
              inputHtml = q.opcoes.map(opt => `<label style="display:block; margin:6px 0;"><input type="checkbox" name="${name}" value="${opt}"> ${opt}</label>`).join('');
            } else {
              inputHtml = `<input class="inp" type="text" spellcheck="true" lang="es">`;
            }
          wrap.innerHTML = `
            <div class="num">${number}.</div>
            <div style="flex:1">
              ${imgHtml}${audioHtml}
              <label class="label">${q.enunciado}</label>
              ${inputHtml}
              <div class="feedback"></div>
            </div>
          `;
          section.appendChild(wrap);
        });

        quiz.appendChild(section);
      }

      totalQuestions = count;

      // Eventos dos inputs
      // substituir por eventos por tipo
      Array.from(document.querySelectorAll('section.card .row')).forEach(row => {
        const type = row.dataset.type || 'text';
        if (type === 'text') {
          const inp = row.querySelector('input.inp');
          if (inp) {
            inp.addEventListener('blur', () => { checkRow(row); updateScore(); });
            inp.addEventListener('input', () => {
              const fb = row.querySelector('.feedback');
              fb.innerHTML = '';
              row.dataset.checked = 'false';
              row.dataset.correct = '0';
            });
          }
        } else if (type === 'select') {
          const sel = row.querySelector('select.sel') || row.querySelector('select');
          if (sel) {
            sel.addEventListener('change', () => { checkRow(row); updateScore(); });
          }
        } else if (type === 'assoc') {
          row.querySelectorAll('select.assoc-sel').forEach(sel => {
            sel.addEventListener('change', () => { checkRow(row); updateScore(); });
          });
        } else if (type === 'checkbox') {
          row.querySelectorAll('input[type=checkbox]').forEach(chk => {
            chk.addEventListener('change', () => { checkRow(row); updateScore(); });
          });
        } else { // mc ou vf
          row.querySelectorAll('input[type=radio]').forEach(radio => {
            radio.addEventListener('change', () => { checkRow(row); updateScore(); });
          });
        }
      });
    }

    function normalize(s) {
      return s.trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function checkField(el) {
      const feedback = el.parentElement.querySelector('.feedback');
      const ans = JSON.parse(el.dataset.gabarito);
      const val = normalize(el.value);
      
      if(!val)
      {
        return;
      }

      const msg = el.dataset.msg || '';
      const isFreeAnswer = (ans || []).length === 0 || 
                          normalize(msg).includes('resposta livre') || 
                          normalize(msg).includes('respuesta libre') ||
                          normalize(msg).includes('free answer');
      
      let isCorrect;
      if (isFreeAnswer) {
        // Para respostas livres, aceita qualquer resposta n√£o vazia
        isCorrect = true;
        feedback.innerHTML = '<div class="ok"><i class="fas fa-check-circle"></i> Resposta recebida<br><small>' + msg + '</small></div>';
      } else {
        isCorrect = ans.some(a => normalize(a) === val);
        if (isCorrect) {
          feedback.innerHTML = '<div class="ok"><i class="fas fa-check-circle"></i> Correto</div>';
        } else {
          const corr = ans[0];
          feedback.innerHTML = `<div class="bad"><i class="fas fa-times-circle"></i> Incorrecto<br><small>Correto: ${corr}<br>${msg}</small></div>`;
        }
      }
      el.dataset.checked = 'true';
      el.dataset.correct = isCorrect ? '1' : '0';
      return isCorrect;
    }

    function clearFeedback(el) {
      const fb = el.parentElement.querySelector('.feedback');
      fb.innerHTML = '';
      el.dataset.checked = 'false';
      el.dataset.correct = '0';
    }

    function checkAll() {
      const rows = Array.from(document.querySelectorAll('section.card .row'));
      let correct = 0;
      rows.forEach(row => { if (checkRow(row)) correct++; });
      const pct = Math.round((correct / totalQuestions) * 100);
      document.getElementById('scoreBox').textContent = `Nota: ${pct}%`;
      document.getElementById('progress').style.width = pct + '%';
    }

    function updateScore() {
      const rows = Array.from(document.querySelectorAll('section.card .row')).filter(row => row.dataset.checked === 'true');
      const correct = rows.filter(row => row.dataset.correct === '1').length;
      const pct = Math.round((correct / totalQuestions) * 100);
      document.getElementById('scoreBox').textContent = `Nota: ${pct}%`;
      document.getElementById('progress').style.width = pct + '%';
    }

    function checkRow(row) {
      const feedback = row.querySelector('.feedback');
      const ans = JSON.parse(row.dataset.gabarito || '[]');
      const type = row.dataset.type || 'text';
      let val = '';
  
      // Verificar se √© resposta livre ANTES de processar a resposta
      const msg = row.dataset.msg || '';
      const isFreeAnswer = (ans || []).length === 0 || 
                          normalize(msg).includes('resposta livre') || 
                          normalize(msg).includes('respuesta libre') ||
                          normalize(msg).includes('free answer');
      
      // Obter valida√ß√£o do dataset (se existir)
      const validacao = row.dataset.validacao ? JSON.parse(row.dataset.validacao) : null;
      
      if (type === 'text') {
        const inp = row.querySelector('input.inp');
        val = inp ? inp.value : '';
      } else if (type === 'select') {
        const sel = row.querySelector('select.sel') || row.querySelector('select');
        val = sel ? (sel.value || sel.options[sel.selectedIndex]?.text || '') : '';
        // Remove "Seleccione..." se presente
        if (val && (normalize(val) === normalize('Seleccione...') || normalize(val) === normalize('Selecione...'))) {
          val = '';
        }
      } else if (type === 'assoc') {
        const sels = Array.from(row.querySelectorAll('select.assoc-sel'));
        const vals = sels.map(sel => sel ? (sel.value || '') : '');
        // se algum estiver vazio, n√£o corrige ainda
        if (vals.some(v => !normalize(String(v)))) {
          return false;
        }
        const valsNorm = vals.map(v => normalize(String(v)));
        const ansArr = (ans || []).map(a => normalize(String(a)));
        const msg = row.dataset.msg || '';
        const isFreeAnswer = (ans || []).length === 0 || 
                            normalize(msg).includes('resposta livre') || 
                            normalize(msg).includes('respuesta libre') ||
                            normalize(msg).includes('free answer');
        
        let isCorrect;
        if (isFreeAnswer) {
          // Para respostas livres, aceita qualquer resposta n√£o vazia
          isCorrect = valsNorm.every(v => v.length > 0);
          if (isCorrect) {
            feedback.innerHTML = '<div class="ok"><i class="fas fa-check-circle"></i> Resposta recebida<br><small>' + msg + '</small></div>';
          } else {
            feedback.innerHTML = '<div class="bad"><i class="fas fa-times-circle"></i> Complete todas as associa√ß√µes</div>';
          }
        } else {
          isCorrect = ansArr.length === valsNorm.length && ansArr.every((a, i) => a === valsNorm[i]);
          if (isCorrect) {
            feedback.innerHTML = '<div class="ok"><i class="fas fa-check-circle"></i> Correto</div>';
          } else {
            const corr = (ans || []).join(', ');
            feedback.innerHTML = `<div class=\"bad\"><i class="fas fa-times-circle"></i> Incorrecto<br><small>Correto: ${corr}<br>${msg}</small></div>`;
          }
        }
        row.dataset.checked = 'true';
        row.dataset.correct = isCorrect ? '1' : '0';
        return isCorrect;
      } else if (type === 'checkbox') {
        const checks = Array.from(row.querySelectorAll('input[type=checkbox]:checked'));
        const vals = checks.map(ch => ch.value);
        const expectedLen = (ans || []).length;
        if (vals.length !== expectedLen) {
          return false;
        }
        const valsNorm = vals.map(v => normalize(String(v))).sort();
        const ansArr = (ans || []).map(a => normalize(String(a))).sort();
        const msg = row.dataset.msg || '';
        const isFreeAnswer = (ans || []).length === 0 || 
                            normalize(msg).includes('resposta livre') || 
                            normalize(msg).includes('respuesta libre') ||
                            normalize(msg).includes('free answer');
        
        let isCorrect;
        if (isFreeAnswer) {
          // Para respostas livres, aceita qualquer sele√ß√£o n√£o vazia
          isCorrect = vals.length > 0;
          if (isCorrect) {
            feedback.innerHTML = '<div class=\"ok\"><i class="fas fa-check-circle"></i> Resposta recebida<br><small>' + msg + '</small></div>';
          } else {
            feedback.innerHTML = '<div class=\"bad\"><i class="fas fa-times-circle"></i> Selecione pelo menos uma op√ß√£o</div>';
          }
        } else {
          isCorrect = ansArr.length === valsNorm.length && ansArr.every((a, i) => a === valsNorm[i]);
          if (isCorrect) {
            feedback.innerHTML = '<div class=\"ok\"><i class="fas fa-check-circle"></i> Correto</div>';
          } else {
            const corr = (ans || []).join(', ');
            feedback.innerHTML = `<div class=\"bad\"><i class="fas fa-times-circle"></i> Incorrecto<br><small>Correto: ${corr}<br>${msg}</small></div>`;
          }
        }
        row.dataset.checked = 'true';
        row.dataset.correct = isCorrect ? '1' : '0';
        return isCorrect;
      } else if (type === 'select') {
        const sel = row.querySelector('select.sel') || row.querySelector('select');
        val = sel ? (sel.value || sel.options[sel.selectedIndex]?.text || '') : '';
        // Remove "Seleccione..." se presente
        if (normalize(val) === normalize('Seleccione...') || normalize(val) === normalize('Selecione...')) {
          val = '';
        }
      } else { // mc ou vf
        const checked = row.querySelector('input[type=radio]:checked');
        val = checked ? checked.value : '';
      }

      const nval = normalize(val);
      
      let isCorrect;
      if (isFreeAnswer) {
        // Para respostas livres, aceita qualquer resposta n√£o vazia
        if (!nval) {
          return false; // Ainda precisa ter algo digitado
        }
        
        // Valida√ß√£o gen√©rica se configurada no JSON
        if (validacao) {
          let isValid = false;
          let errorMsg = '';
          
          if (validacao.tipo === 'lista' && Array.isArray(validacao.valores)) {
            // Valida√ß√£o por lista de valores v√°lidos
            isValid = validacao.valores.some(v => {
              const vNorm = normalize(String(v));
              return vNorm === nval || nval.includes(vNorm) || vNorm.includes(nval);
            });
            if (!isValid) {
              errorMsg = validacao.mensagem || `Por favor, escriba una respuesta v√°lida. Opciones: ${validacao.valores.join(', ')}`;
            }
          } else if (validacao.tipo === 'minLength' && validacao.min) {
            // Valida√ß√£o por tamanho m√≠nimo
            isValid = nval.length >= validacao.min;
            if (!isValid) {
              errorMsg = validacao.mensagem || `La respuesta debe tener al menos ${validacao.min} caracteres.`;
            }
          } else if (validacao.tipo === 'regex' && validacao.patron) {
            // Valida√ß√£o por express√£o regular
            try {
              const regex = new RegExp(validacao.patron, validacao.flags || 'i');
              isValid = regex.test(val);
              if (!isValid) {
                errorMsg = validacao.mensagem || 'La respuesta no cumple con el formato requerido.';
              }
            } catch (e) {
              console.error('Error en regex de validaci√≥n:', e);
              isValid = true; // Se houver erro no regex, aceita
            }
          } else if (validacao.tipo === 'spellcheck') {
            // Valida√ß√£o ortogr√°fica usando LanguageTool API (ass√≠ncrona)
            // Mostrar feedback de "verificando" e fazer valida√ß√£o em background
            feedback.innerHTML = '<div class="info"><i class="fas fa-spinner fa-spin"></i> Verificando ortograf√≠a...</div>';
            
            // Valida√ß√£o ass√≠ncrona
            (async () => {
              try {
                const words = val.trim().split(/\s+/).filter(w => w.length > 2);
                if (words.length === 0) {
                  isCorrect = true;
                  feedback.innerHTML = '<div class="ok"><i class="fas fa-check-circle"></i> Resposta recebida<br><small>' + msg + '</small></div>';
                  row.dataset.checked = 'true';
                  row.dataset.correct = '1';
                  updateScore();
                  return;
                }
                
                // Usar API p√∫blica do LanguageTool (gratuita, com limite de requisi√ß√µes)
                const response = await fetch(`https://api.languagetool.org/v2/check`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: `text=${encodeURIComponent(val)}&language=es&enabledOnly=false`
                });
                
                if (response.ok) {
                  const data = await response.json();
                  const errors = data.matches || [];
                  
                  // Filtrar apenas erros ortogr√°ficos (n√£o gramaticais)
                  const spellingErrors = errors.filter(e => 
                    e.rule && e.rule.category && 
                    (e.rule.category.id === 'TYPOS' || e.rule.category.id === 'SPELLING')
                  );
                  
                  if (spellingErrors.length > 0) {
                    // Detalhar cada erro com palavra, contexto e sugest√µes
                    const errorDetails = spellingErrors.map(e => {
                      const word = val.substring(e.offset, e.offset + e.length);
                      const context = val.substring(Math.max(0, e.offset - 10), Math.min(val.length, e.offset + e.length + 10));
                      const suggestions = (e.replacements || []).slice(0, 3).map(r => r.value).join(', ');
                      const message = e.message || e.rule?.description || 'Error ortogr√°fico';
                      
                      let detail = `<strong>"${word}"</strong>`;
                      if (suggestions) {
                        detail += ` ‚Üí Sugerencias: ${suggestions}`;
                      }
                      if (message) {
                        detail += ` (${message})`;
                      }
                      return detail;
                    });
                    
                    isCorrect = false;
                    const baseMsg = validacao.mensagem || 'Se detectaron errores ortogr√°ficos:';
                    errorMsg = `${baseMsg}<br><small style="display: block; margin-top: 8px; line-height: 1.6;">${errorDetails.join('<br>')}</small>`;
                    
                    feedback.innerHTML = `<div class="bad"><i class="fas fa-times-circle"></i> ${errorMsg}</div>`;
                    row.dataset.checked = 'true';
                    row.dataset.correct = '0';
                  } else {
                    isCorrect = true;
                    feedback.innerHTML = '<div class="ok"><i class="fas fa-check-circle"></i> Resposta recebida<br><small>' + msg + '</small></div>';
                    row.dataset.checked = 'true';
                    row.dataset.correct = '1';
                  }
                } else {
                  // Se a API falhar, aceita a resposta (n√£o bloqueia)
                  isCorrect = true;
                  feedback.innerHTML = '<div class="ok"><i class="fas fa-check-circle"></i> Resposta recebida<br><small>' + msg + '</small></div>';
                  row.dataset.checked = 'true';
                  row.dataset.correct = '1';
                }
              } catch (e) {
                console.error('Error en verificaci√≥n ortogr√°fica:', e);
                // Se a API falhar, aceita a resposta (n√£o bloqueia)
                isCorrect = true;
                feedback.innerHTML = '<div class="ok"><i class="fas fa-check-circle"></i> Resposta recebida<br><small>' + msg + '</small></div>';
                row.dataset.checked = 'true';
                row.dataset.correct = '1';
              }
              
              updateScore();
            })();
            
            // Retornar true temporariamente enquanto verifica (ser√° atualizado assincronamente)
            return true;
          }
          
          if (!isValid && errorMsg && validacao.tipo !== 'spellcheck') {
            isCorrect = false;
            feedback.innerHTML = `<div class="bad"><i class="fas fa-times-circle"></i> ${errorMsg}</div>`;
            row.dataset.checked = 'true';
            row.dataset.correct = '0';
            return false;
          }
        }
        
        isCorrect = true;
        feedback.innerHTML = '<div class="ok"><i class="fas fa-check-circle"></i> Resposta recebida<br><small>' + msg + '</small></div>';
      } else {
        if (!nval) {
          return false;
        }
        isCorrect = (ans || []).some(a => normalize(String(a)) === nval);
        if (isCorrect) {
          feedback.innerHTML = '<div class="ok"><i class="fas fa-check-circle"></i> Correto</div>';
        } else {
          const corr = (ans || [])[0] ?? '';
          feedback.innerHTML = `<div class="bad"><i class="fas fa-times-circle"></i> Incorrecto<br><small>Correto: ${corr}<br>${msg}</small></div>`;
        }
      }
      row.dataset.checked = 'true';
      row.dataset.correct = isCorrect ? '1' : '0';
      return isCorrect;
    }

    loadSimulado();
    
    // Dark Mode Toggle
    function toggleDarkMode() {
      const body = document.body;
      const btn = document.getElementById('btnDarkMode');
      const icon = btn.querySelector('i');
      
      body.classList.toggle('dark-mode');
      const isDark = body.classList.contains('dark-mode');
      
      if (isDark) {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
        localStorage.setItem('darkMode', 'enabled');
      } else {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
        localStorage.setItem('darkMode', 'disabled');
      }
    }
    
    // Carregar prefer√™ncia de dark mode
    function loadDarkModePreference() {
      const darkMode = localStorage.getItem('darkMode');
      const body = document.body;
      const btn = document.getElementById('btnDarkMode');
      const icon = btn.querySelector('i');
      
      if (darkMode === 'enabled') {
        body.classList.add('dark-mode');
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
      }
    }
    
    // Carregar prefer√™ncia ao iniciar
    loadDarkModePreference();
  </script>
  <script>
  // Ajuste din√¢mico: posiciona a barra de progresso sticky logo abaixo do header
  (function(){
    function updateStickyTop(){
      const header = document.querySelector('header');
      const sticky = document.querySelector('.sticky-top');
      if (!header || !sticky) return;
      const h = header.offsetHeight;
      sticky.style.top = h + 'px';
    }
    window.addEventListener('load', updateStickyTop);
    window.addEventListener('resize', updateStickyTop);
  })();
  </script>
  <!-- Bot√µes flutuantes: Ir ao topo e Ir ao final -->
  <script>
  (function(){
    // Bot√£o Ir ao Topo
    const btnTopo = document.createElement('button');
    btnTopo.id = 'btnTopo';
    btnTopo.type = 'button';
    btnTopo.setAttribute('aria-label', 'Ir ao topo');
    btnTopo.title = 'Ir ao topo';
    btnTopo.innerHTML = '<i class="fas fa-arrow-up" aria-hidden="true"></i>';
    Object.assign(btnTopo.style, {
      position: 'fixed',
      right: '20px',
      bottom: '80px',
      zIndex: '9999',
      width: '56px',
      height: '56px',
      padding: '0',
      borderRadius: '50%',
      background: 'linear-gradient(135deg,#4f46e5,#3b82f6)',
      color: '#fff',
      border: 'none',
      boxShadow: '0 6px 14px rgba(0,0,0,0.2)',
      cursor: 'pointer',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      transition: 'all 0.3s ease'
    });
    
    // Bot√£o Ir ao Final
    const btnFinal = document.createElement('button');
    btnFinal.id = 'btnFinal';
    btnFinal.type = 'button';
    btnFinal.setAttribute('aria-label', 'Ir ao final');
    btnFinal.title = 'Ir ao final';
    btnFinal.innerHTML = '<i class="fas fa-arrow-down" aria-hidden="true"></i>';
    Object.assign(btnFinal.style, {
      position: 'fixed',
      right: '20px',
      bottom: '20px',
      zIndex: '9999',
      width: '56px',
      height: '56px',
      padding: '0',
      borderRadius: '50%',
      background: 'linear-gradient(135deg,#6366f1,#8b5cf6)',
      color: '#fff',
      border: 'none',
      boxShadow: '0 6px 14px rgba(0,0,0,0.2)',
      cursor: 'pointer',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      transition: 'all 0.3s ease'
    });
    
    // Mostrar bot√µes apenas ap√≥s rolar um pouco
    btnTopo.style.display = 'none';
    btnFinal.style.display = 'none';
    
    let ticking = false;
    const onScroll = () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          const scrollY = window.scrollY;
          const windowHeight = window.innerHeight;
          const documentHeight = document.documentElement.scrollHeight;
          const isNearBottom = (scrollY + windowHeight) >= (documentHeight - 100);
          
          // Mostrar bot√£o topo se rolou mais de 200px
          btnTopo.style.display = scrollY > 200 ? 'flex' : 'none';
          
          // Mostrar bot√£o final se n√£o estiver perto do final
          btnFinal.style.display = !isNearBottom && scrollY > 200 ? 'flex' : 'none';
          
          ticking = false;
        });
        ticking = true;
      }
    };
    window.addEventListener('scroll', onScroll, { passive: true });
  
    // Efeitos hover
    btnTopo.addEventListener('mouseenter', () => { btnTopo.style.transform = 'scale(1.06)'; });
    btnTopo.addEventListener('mouseleave', () => { btnTopo.style.transform = 'scale(1)'; });
    btnFinal.addEventListener('mouseenter', () => { btnFinal.style.transform = 'scale(1.06)'; });
    btnFinal.addEventListener('mouseleave', () => { btnFinal.style.transform = 'scale(1)'; });
  
    // A√ß√µes dos bot√µes
    btnTopo.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    btnFinal.addEventListener('click', () => {
      window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
    });
  
    document.body.appendChild(btnTopo);
    document.body.appendChild(btnFinal);
  })();
  </script>
</body>
</html>